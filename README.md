# VulnerabilityMQTT

## Setup
Up PACS-server, MQTT-broker, HomeAssistant and MariaDB
```shell
docker-compose build
docker-compose up -d 
```
For work with mqtt from HomeAssistant add this to `homeassistant/config/configuration.yaml`
```
mqtt:
broker: <broker_ip>

switch:
- platform: mqtt
  unique_id: 1
  name: "Ariston"
  command_topic: "light/1"
  qos: 1
  payload_on: "on"
  payload_off: "off"
  state_on: "ON"
  state_off: "OFF"
  retain: true
```

Then add MQTT to Integrations in HomeAssistant settings:

Settings -> Integrations -> ( + add Integration) -> MQTT

## Work with PACS-server
### RC522
* Port: `8080`
* Protocol: **HTTP**
* Request method: **POST**
* Route: `/check`
* JSON payload: `{"rfid":"<card_id>"}`
* Server answers: `ok/error`
* Curl example: 
```shell
curl --header "Content-Type: application/json" --request POST --data '{"rfid":"1"}' http://localhost:8080/check
```

### Door relay
* Protocol: **MQTT**
* Topic: `door/<door_id_int>/`
* Payloads: `open/close`
* Publish example: `door/1/ open`
* mosquitto_sub example:
```shell
mosquitto_sub -h localhost -t "door/1/" -u "mosquitto" -P "mosquitto"
```

## Exploitation
### Brute Broker pass
Script for bruteforce login:pass from dictionaries
```shell
go run exploitation/bruteforce/main.go
```
Output after some time:
```shell
Get valid Credentials
Login: <login>
Password: <password>
```

### Sniff all MQTT traffic
Utility for sniffing remote MQTT traffic 
```shell
go run exploitation/sniff/main.go
```
Check logs:
```shell
tail -f exploitation/sniff/commands.csv 
...
Mar  3 21:30:46,light/1/,off
Mar  3 21:30:50,light/1/,on
```

### Execute commands
Simple shell for remote execute commands
```shell
go run exploitation/execute/main.go
```
Output:
```shell
Connected to tcp://<broker_ip>:1883
Top of topics:
0. light/1/
...
Choose topic: 0
------------------
[Topic] <- Command
------------------
[light/1/] <- on
[light/1/] <- off

```

